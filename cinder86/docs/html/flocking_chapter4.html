<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Cinder: Flocking Chapter 4: Rule Three - Alignment</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="cinder_extra_doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.libcinder.org"><img alt="Logo" src="logo.png"/></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Cinder
   &#160;<span id="projectnumber">0.8.6</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Flocking Chapter 4: Rule Three - Alignment </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="alignment"></a>
RULE 3: ALIGNMENT</h1>
<p><br />
</p><div class="image">
<img src="rule3.jpg" alt="rule3.jpg"/>
</div>
<p> <br />
 <br />
It is time to introduce the third rule. As you recall, the first rule was an act of separation. If an object gets too crowded, it tries to move away from its neighbors. The second rule is an act of cohesion. If an object moves too far away, it tries to move towards its neighbors. These two rules alone are enough to make some interesting flocking simulations. The resulting look is not too dissimilar from how tiny winged insects behave: a seemingly chaotic wandering but still exhibiting some group behavior. <br />
 <br />
Rule 3 gets us to a more familiar and less random looking system. This rule says that if a neighbor is not too far away or too close, then emulate its velocity. Or in other words, move like your neighbors move. <br />
 <br />
Let's bring back the <em>applyForce()</em> method to see what changes were made to accommodate this new third zone. <br />
 <br />
 
<div class="fragment"><pre class="fragment"><span style="font-size: x-small; line-height: 1px;">void ParticleController::applyForce( float zoneRadiusSqrd, float lowThresh, float highThresh  )
{
    for( list::iterator p1 = mParticles.begin(); p1 != mParticles.end(); ++p1 ) {
        list::iterator p2 = p1;
        for( ++p2; p2 != mParticles.end(); ++p2 ) {
            Vec3f dir = p1-&gt;mPos - p2-&gt;mPos;
            float distSqrd = dir.lengthSquared();

            if( distSqrd &lt; zoneRadiusSqrd ) { <span style="color: #888888;">// If the neighbor is within the zone radius...</span>
                float percent = distSqrd/zoneRadiusSqrd;

                if( percent &lt; lowThresh ) { <span style="color: #888888;">// ... and is within the lower threshold limits, separate...</span>
                    <span style="color: #3366ff;">float F = ( lowThresh/percent - 1.0f ) * 0.01f;
                    dir = dir.normalize() * F;
                    p1-&gt;mAcc += dir;
                    p2-&gt;mAcc -= dir;</span>
                }
                else if( percent &lt; highThresh ) { <span style="color: #888888;">// ... else if it is within the higher threshold limits, align...</span>
                    <span style="color: #008000;">float threshDelta = highThresh - lowThresh;
                    float adjustedPercent = ( percent - lowThresh )/threshDelta;
                    float F = ( 0.5f - cos( adjustedPercent * M_PI * 2.0f ) * 0.5f + 0.5f ) * 0.01f;
                    p1-&gt;mAcc += p2-&gt;mVel.normalized() * F;
                    p2-&gt;mAcc += p1-&gt;mVel.normalized() * F;</span>
                }
                else { <span style="color: #888888;">// ... else, attract.</span>
                    <span style="color: #ff0000;">float threshDelta = 1.0f - highThresh;
                    float adjustedPercent = ( percent - highThresh )/threshDelta;
                    float F = ( 0.5f - cos( adjustedPercent * M_PI * 2.0f ) * 0.5f + 0.5f ) * 0.01f;
                    dir = dir.normalize() * F;
                    p1-&gt;mAcc -= dir;
                    p2-&gt;mAcc += dir;</span>
                }
            }
        }
    }
}</span></pre></div>
</p>
<p><br />
The orientation force is similar to what we are doing with the cohesive force. We normalize the Particle's position within the range which it finds itself, and then use that normalized position to find the position along the inverted cosine. Here is what our curve now looks like. <br />
 <br />
</p><div class="image">
<img src="curve3.jpg" alt="curve3.jpg"/>
</div>
<p> <br />
 <br />
There is another difference with the alignment force that is different from separation and cohesion forces. The alignment force doesn't care about the vector between the interacting particles. It is more interested in the other particle's current velocity. This is why we are referencing <em>mVel</em> of the other Particle instead of manipulating the <em>dir</em> vector between Particles. If you are not too close to me and not too far away from me, I want to start moving in the direction you are moving. This simple process is what helps to create group flocking behavior in a random collection of particles with random starting positions and random starting velocities. <br />
 <br />
When you run the Chapter 4 Flocking app, you will get a random mess of particles but after a couple seconds, groups will begin to form. <br />
 <br />
</p><div class="image">
<img src="chapter4b.jpg" alt="chapter4b.jpg"/>
</div>
<p> <br />
 <br />
It is not uncommon for the flocking Particles to begin to form vortices that are characteristic of many species of fish. In the image below, thousands of sardines swim into a tight formation known as a <a href="http://en.wikipedia.org/wiki/Shoaling_and_schooling">bait ball</a> which is a type of shoaling. <br />
 <br />
</p><div class="image">
<img src="3706256557_a98ab377d1_b.jpg" alt="3706256557_a98ab377d1_b.jpg"/>
</div>
<p><em>Photo credit: Erwin Poliakoff (Flickr:epddiver)</em> <br />
<br />
</p><div class="image">
<img src="chapter4a.jpg" alt="chapter4a.jpg"/>
</div>
<p> <br />
 <br />
There you have it. A fairly basic 3D flocking particle simulation. In <a class="el" href="flocking_chapter5.html">Flocking Chapter 5</a>, we are going to show different ways you can improve the behavior of the flocking and also add in a few predators.</p>
<p><br />
</p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
