<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Cinder: Chapter 5: External Forces</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="cinder_extra_doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.libcinder.org"><img alt="Logo" src="logo.png"/></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Cinder
   &#160;<span id="projectnumber">0.8.6</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Chapter 5: External Forces </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="personalSpace"></a>
Personal space</h1>
<p>At the end of the last section, we had a nice <code>Particle</code> emitter cursor trail. As you drag the cursor around, you leave a trail of hundreds of moving <code>Particle</code>s. Every one of those <code>Particle</code>s is responding to its initial starting velocity combined with a hint of <a class="el" href="classcinder_1_1_perlin.html">Perlin</a> noise. Each <code>Particle</code> does its thing and is oblivious to what any of the <code>Particle</code>s are doing. Until now.<br />
<br />
We are going to implement a very basic repulsive force to each <code>Particle</code>. Every single <code>Particle</code> will push away every other <code>Particle</code>. We will do this by giving each <code>Particle</code> an acceleration vector called <code>mAcc</code>.<br />
<br />
Here is how it will work. From the <code>ParticleController</code>, we will iterate through all the <code>Particle</code>s. For each <code>Particle</code>, we check it against all other <code>Particle</code>s. If those two <code>Particle</code>s are close, they will push each other away more strongly than if the two <code>Particle</code>s are on opposite sides of the app window. We add that repulsion to the respective <code>Particle</code>s' <code>mAcc</code> vectors.<br />
<br />
Once we have iterated through all the <code>Particle</code>s, we add the acceleration to the velocity. Then we add the velocity to the position. We decay the velocity. We reset the acceleration. And we repeat.<br />
<br />
The abridged version of what each <code>Particle</code> will go through looks like this: </p><div class="fragment"><div class="line">mVel += mAcc;</div>
<div class="line">mLoc += mVel;</div>
<div class="line">mVel *= mDecay;</div>
<div class="line">mAcc.set( 0, 0 );</div>
</div><!-- fragment --><p> <br />
We are also adding a new variable to represent the <code>Particle</code>'s mass which is directly related to the radius. The actual relationship is a matter of personal taste. Once we make use of the mass variable, you might find you like how things behave if your <code>Particle</code>s are really massy. I like my <code>Particle</code>s a little more floaty. </p><div class="fragment"><div class="line">mMass = mRadius * mRadius * 0.005f;</div>
</div><!-- fragment --><p> <br />
This formula is not based on anything other than trial and error. I tried setting the mass equal to the radius. Didn't like that. I tried mass equal to radius squared. Didn't like that. I eventually settled on taking a fraction of the radius squared.<br />
<br />
</p>
<h1><a class="anchor" id="repulsion"></a>
Basic Repulsive Force</h1>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ParticleController::repulseParticles() {</div>
<div class="line">    <span class="keywordflow">for</span>( list&lt;Particle&gt;::iterator p1 = mParticles.begin(); p1 != mParticles.end(); ++p1 ) {</div>
<div class="line">        list&lt;Particle&gt;::iterator p2 = p1;</div>
<div class="line">        <span class="keywordflow">for</span>( ++p2; p2 != mParticles.end(); ++p2 ) {</div>
<div class="line">            <a class="code" href="namespacecinder.html#ad2764a1271ad16462755205deb72a71e">Vec2f</a> dir = p1-&gt;mLoc - p2-&gt;mLoc;</div>
<div class="line">            <span class="keywordtype">float</span> distSqrd = dir.<a class="code" href="classcinder_1_1_vec2.html#a88c4cc1851f4b497c337c01d78aafffa">lengthSquared</a>();</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">if</span>( distSqrd &gt; 0.0f ){</div>
<div class="line">                dir.normalize();</div>
<div class="line">                <span class="keywordtype">float</span> F = 1.0f/distSqrd;</div>
<div class="line">                    </div>
<div class="line">                p1-&gt;mAcc += dir * ( F / p1-&gt;mMass );</div>
<div class="line">                p2-&gt;mAcc -= dir * ( F / p2-&gt;mMass );</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br />
Lets go through this step by step. First, you set up a for-loop that uses the <code>list</code> <code>iterator</code> to go through all the <code>Particle</code>s, one by one, in the order they are sorted in the list. </p><div class="fragment"><div class="line"><span class="keywordflow">for</span>( list&lt;Particle&gt;::iterator p1 = mParticles.begin(); p1 != mParticles.end(); ++p1 ){</div>
</div><!-- fragment --><p> <br />
Next, we create a second <code>iterator</code> that also loops through the <code>Particle</code>s, but it starts at one <code>Particle</code> ahead of the first <code>iterator</code>'s position. Put another way, if we are on <code>Particle</code> 15 in the first <code>iterator</code>, the second <code>iterator</code> will loop through <code>Particle</code>s 16 and higher. <code>Particle</code> 16 will <code>iterate</code> through <code>Particle</code> 17 and higher, etc.<br />
<br />
Put yet another way, imagine that we have 3 <code>Particle</code>s. Each <code>Particle</code> wants to repel every other <code>Particle</code>. First round, p1 and p2 repel each other, and then p1 and p3 repel each other. Second round, we already handled all of p1's interactions so we move on to p2. Since p2 has already interacted with p1, all that is left is for p2 and p3 to repel each other. That is the logic for the nested <code>iterator</code>s. </p><div class="fragment"><div class="line">list&lt;Particle&gt;::iterator p2 = p1;</div>
<div class="line"><span class="keywordflow">for</span>( ++p2; p2 != mParticles.end(); ++p2 ) {</div>
</div><!-- fragment --><p> <br />
Now that we are inside of the second <code>iterator</code>, we are dealing with a single pair of <code>Particle</code>s, p1 and p2. We know both of their positions so we can find the vector between them by subtracting p1's position from p2's position. We can then find out how far apart they are by using <code><a class="el" href="_g_lee_8h.html#a3c8469415bbc83dd1341af15c67f1cef">length()</a></code>. </p><div class="fragment"><div class="line"><a class="code" href="namespacecinder.html#ad2764a1271ad16462755205deb72a71e">Vec2f</a> dir = p1-&gt;mLoc - p2-&gt;mLoc;</div>
<div class="line"><span class="keywordtype">float</span> dist = dir.<a class="code" href="classcinder_1_1_vec2.html#a611793685d66f6129902037d330f43db">length</a>();</div>
</div><!-- fragment --><p> <br />
Here is where we run into our first problem. To do this repulsion force, we don't need the distance between the <code>Particle</code>s. We need the distance squared. We could just multiply <code>dist</code> by <code>dist</code> and be done with it, but we have another option.<br />
<br />
When finding out the length of a vector, you first find out the squared distance, then you take the square root. The code for finding the <code><a class="el" href="_g_lee_8h.html#a3c8469415bbc83dd1341af15c67f1cef">length()</a></code> looks like this: </p><div class="fragment"><div class="line">sqrt( x*x + y*y )</div>
</div><!-- fragment --><p> <br />
You should try to avoid using <code>sqrt()</code> when possible, especially inside of a huge nested loop. It will definitely slow things down as the square root calculation is much more processor-intensive than just adding or multiplying. The good news is there is also a <code>lengthSquared()</code> method we can use. </p><div class="fragment"><div class="line"><a class="code" href="namespacecinder.html#ad2764a1271ad16462755205deb72a71e">Vec2f</a> dir = p1-&gt;mLoc - p2-&gt;mLoc;</div>
<div class="line"><span class="keywordtype">float</span> distSqrd = dir.<a class="code" href="classcinder_1_1_vec2.html#a88c4cc1851f4b497c337c01d78aafffa">lengthSquared</a>();</div>
</div><!-- fragment --><p> <br />
Next, we make sure the distance squared is not equal to zero. One of the next steps is to normalize the direction vector and we already know that normalizing a vector with a length of zero is a bad thing. </p><div class="fragment"><div class="line"><span class="keywordflow">if</span>( distSqrd &gt; 0.0f ){</div>
</div><!-- fragment --><p> <br />
Here is the sparkling jewel of our function. First, you go ahead and normalize the direction vector. This leaves you with a vector that has a length of one and can be thought of as an arrow pointing from p2 towards p1. </p><div class="fragment"><div class="line">dir.normalize();</div>
</div><!-- fragment --><p> <br />
The first factor which determines how much push each <code>Particle</code> has on the other is the inverse of the distance squared. </p><div class="fragment"><div class="line"><span class="keywordtype">float</span> F = 1.0f / distSqrd;</div>
</div><!-- fragment --><p> <br />
Since we already know that force equals mass times acceleration (Newton's 2nd law), we can find p2's contribution to p1's total acceleration by <em>adding</em> the force divided by p1's mass. </p><div class="fragment"><div class="line">p1-&gt;mAcc += ( F * dir ) / p1-&gt;mMass;</div>
</div><!-- fragment --><p> <br />
To find out p1's contribution to p2's total acceleration, you <em>subtract</em> force divided by p2's mass. </p><div class="fragment"><div class="line">p2-&gt;mAcc -= ( F * dir ) / p2-&gt;mMass;</div>
</div><!-- fragment --><p> <br />
If this all seems confusing to you, worry not. It still confuses me from time to time. With a little bit of practice, this code will start to feel more familiar.<br />
<br />
Now we can turn on our repulsion. In our App class, before we tell the <code>ParticleController</code> to update all the <code>Particle</code>s, we trigger the <code>ParticleController::repulseParticles()</code> method. We can now run our code. <br />
<br />
</p><div class="image">
<img src="tutorial_part5_01.png" alt="tutorial_part5_01.png"/>
</div>
<p> <br />
Every single Particle pushes away its neighbors which causes the <code>Particle</code>s to spread out in a really natural manner. Here is a short video of the effect in action. <br />
 <!--  </p><div class="image">
<img src="tutorial_part5_01.mov" alt="tutorial_part5_01.mov"/>
</div>
<p>--&gt;&lt;embed width="800" height="620" target="myself" autoplay="false" src="tutorial_part5_01.mov" pluginspage="http://www.apple.com/quicktime/download/index.html"&gt;&lt;/embed&gt;  <br />
Ready for something special? Try this. Turn off the <code>Particle</code>'s ability to age. Turn off the <a class="el" href="classcinder_1_1_perlin.html">Perlin</a> noise influence. And finally, put back the <a class="el" href="classcinder_1_1_channel_t.html">Channel</a>-based variable radius. Once you add a few thousand <code>Particle</code>s, you should get back something like this. <br />
 <!--  </p><div class="image">
<img src="tutorial_part5_02.mov" alt="tutorial_part5_02.mov"/>
</div>
<p>--&gt;&lt;embed width="800" height="620" target="myself" autoplay="false" src="tutorial_part5_02.mov" pluginspage="http://www.apple.com/quicktime/download/index.html"&gt;&lt;/embed&gt;  <br />
During the course of this tutorial, we have managed to create a robust stippling algorithm almost by accident. We started with a simple image loading example and some randomly moving circles. After a few minor iterations, we have written a pretty cool program that will dynamically stipple images by simply combining a particle engine with a repulsive force.<br />
<br />
Hopefully you are inspired and anxious to continue exploring. This is not an end - there is so much more to do. Try adding a third dimension to this project. Experiment with different types of external and internal forces. Try mixing different <em>flavors</em> of Particles together. Find new ways to control the Particles such as microphone input or webcam. Trace the path the particles travel over time. Draw the connections between neighboring particles. Or maybe don't draw the particles at all and instead only draw their collisions. So many options! So many paths to explore. And it all started from an empty black window.<br />
<br />
Where to now? Have a peek in the <a href="http://libcinder.org/gallery/">Gallery</a> to see what others are up to with Cinder, or read more about the <a href="http://libcinder.org/features/">Features</a> for ideas on what to explore. If you have questions, comments, ideas, or work to share, hop on over to the <a href="http://forum.libcinder.org/#AllForums">Cinder forum</a>. On behalf of its whole community, let me say that we're excited you've taken the time to check out Cinder, and we hope you'll come join in. <br />
</p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
